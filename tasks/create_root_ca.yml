---
- name: "create_root_ca | Check if destination exist for ROOT CA"
  register: root_ca_path_stat
  ansible.builtin.stat:
    path: "{{ root_ca_path }}"

- name: "create_root_ca | Create a bundle ZIP for ROOT CA: {{ bootstrap_ssl_root_ca.cn }}"
  when: not root_ca_path_stat.stat.exists
  block:
    - name: "create_root_ca | Create the new destination directory"
      ansible.builtin.file:
        path: "{{ root_ca_path }}/"
        state: directory
        recurse: yes
        owner: "{{ bootstrap_ssl_user }}"
        group: "{{ bootstrap_ssl_user }}"
        mode: 0700

    - name: "create_root_ca | Create a KEY of {{ bootstrap_ssl_key_size }}"
      register: output
      changed_when: output.rc != 0
      ansible.builtin.command: "openssl genpkey -algorithm RSA -out {{ root_ca_filename }}.key -pkeyopt rsa_keygen_bits:{{ bootstrap_ssl_key_size }}"

    - name: "create_root_ca | Create a CSR"
      register: output
      changed_when: output.rc != 0
      ansible.builtin.command: "openssl req -new -key {{ root_ca_filename }}.key -out {{ root_ca_filename }}.csr -subj \"/C={{ bootstrap_ssl_root_ca.c }}/ST={{ bootstrap_ssl_root_ca.st }}/L={{ bootstrap_ssl_root_ca.l }}/O={{ bootstrap_ssl_root_ca.o }}/OU={{ bootstrap_ssl_root_ca.ou }}/emailAddress={{ bootstrap_ssl_root_ca.email_address }}/CN={{ bootstrap_ssl_root_ca.cn }}\" -days {{ bootstrap_ssl_validity }}"

    - name: "create_root_ca | Sign a CRT"
      register: output
      changed_when: output.rc != 0
      ansible.builtin.command: "openssl x509 -req -in {{ root_ca_filename }}.csr -signkey {{ root_ca_filename }}.key -out {{ root_ca_filename }}.crt"

    - name: "create_root_ca | Converte the CRT into PEM"
      register: output
      changed_when: output.rc != 0
      ansible.builtin.command: "openssl x509 -in {{ root_ca_filename }}.crt -outform pem -out {{ root_ca_filename }}.pem"

    - name: "create_root_ca | Create ZIP bundle"
      register: output
      changed_when: output.size <= 0
      community.general.archive:
        path: "{{ root_ca_path }}"
        dest: "{{ root_ca_path }}.zip"
        format: zip
        owner: "{{ bootstrap_ssl_user }}"
        group: "{{ bootstrap_ssl_user }}"
        mode: 0700
